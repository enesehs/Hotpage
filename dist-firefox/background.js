const n="hotpage-settings";let i=null;chrome.runtime.onInstalled.addListener(()=>{console.log("HotPage Extension Installed")});chrome.commands.onCommand.addListener(r=>{r==="toggle-sticky-notes"&&chrome.tabs.query({active:!0,currentWindow:!0},t=>{t[0]?.id&&chrome.tabs.sendMessage(t[0].id,{type:"TOGGLE_STICKY"}).catch(()=>{})})});chrome.runtime.onMessage.addListener((r,t,o)=>{if(r.type==="TOGGLE_STICKY_ALL")return chrome.tabs.query({},e=>{e.forEach(s=>{s.id&&s.id!==t.tab?.id&&chrome.tabs.sendMessage(s.id,{type:"TOGGLE_STICKY"}).catch(()=>{})})}),o({success:!0}),!0;if(r.type==="FETCH_RSS")return p(r.url).then(e=>o({success:!0,data:e})).catch(e=>o({success:!1,error:e.message})),!0});async function p(r){const t=new AbortController,o=setTimeout(()=>t.abort(),15e3);try{const e=await fetch(r,{signal:t.signal,headers:{Accept:"application/rss+xml, application/xml, text/xml, */*"}});if(clearTimeout(o),!e.ok)throw new Error(`HTTP ${e.status}`);const s=await e.text();if(!s.trim().startsWith("<"))throw new Error("Invalid RSS format");return s}catch(e){throw clearTimeout(o),e}}function g(){i||(console.log("[HotPage] Starting Pomodoro timer"),i=setInterval(()=>{chrome.storage.local.get([n],r=>{const t=r[n];if(!t?.stickyNote?.pomodoro?.isRunning){m();return}const o=t.stickyNote,e=o.pomodoro.timeLeft-1;let s;if(e<=0){console.log("[HotPage] Timer complete. Current mode:",o.pomodoro.mode),console.log("[HotPage] Current sessions:",o.pomodoro.sessionsCompleted);const l=Number(o.pomodoro.sessionsCompleted)||0,d=o.pomodoro.mode==="work"||o.pomodoro.mode==="custom",a=d?l+1:l,c=d?a%4===0?"longBreak":"shortBreak":"work",u=c==="work"?o.pomodoro.workDuration*60:c==="shortBreak"?o.pomodoro.shortBreakDuration*60:o.pomodoro.longBreakDuration*60;console.log("[HotPage] Next sessions:",a),console.log("[HotPage] Next mode:",c),chrome.notifications.create("pomodoro-complete",{type:"basic",iconUrl:"img/White/White_128.png",title:"Pomodoro Timer",message:o.pomodoro.mode==="work"?"Work session complete! Time for a break.":"Break is over! Time to focus.",priority:2}),s={...o.pomodoro,isRunning:!1,mode:c,timeLeft:u,sessionsCompleted:a},m()}else s={...o.pomodoro,timeLeft:e};chrome.storage.local.set({[n]:{...t,stickyNote:{...o,pomodoro:s}}})})},1e3))}function m(){i&&(console.log("[HotPage] Stopping Pomodoro timer"),clearInterval(i),i=null)}chrome.storage.onChanged.addListener((r,t)=>{if(t!=="local"||!r[n])return;const e=r[n].newValue?.stickyNote?.pomodoro?.isRunning;console.log("[HotPage] Storage changed, isRunning:",e),e&&!i?g():!e&&i&&m()});chrome.storage.local.get([n],r=>{const t=r[n];console.log("[HotPage] Startup check, isRunning:",t?.stickyNote?.pomodoro?.isRunning),t?.stickyNote?.pomodoro?.isRunning&&g()});
